document.addEventListener("DOMContentLoaded", function(event) {

/*ПАРСИМ ИНФОРМАЦИЮ О ПРОЕКТОВ ИЗ БЛОКА "СЕТКА ОБЪЕКТОВ"*/

function parseProjectsBlock (blockClass){
		const projectsBlock = document.querySelector(blockClass); // ссылка на блок "проекты"
		const projectsData = document.querySelectorAll(blockClass +' .t404__tag'); // массив с ссылками на все элементы содержащие строки, которые необходимо привести к JSON и добавить в projects
		let projects = []; // Массив для хранения найденной информации парсером

		projectsData.forEach((data) => {
			//В этом цикле проводится проверка каждой возвращаемой сервером строки с data для каждого объект.
			//Если при компиляции вылавливается ошибка, то возвращаетмя сообщение в консоль.
			//Если формат данных корректен, то парсер приводит их в JSON объект, который далее добавляется в массив projects.

			try {
				let projectData = JSON.parse(data.innerText); // парсим данные по данному проекту
				projectData.projectElm = data.closest('.t404__col');// каждому объекту необходимо дать ссылку на связанный с ним DOM Node (projectNode)
				projects.push(projectData); // добавляем JSON объект в массив
			} catch(err) {
				console.error("Парсинг данных объекта не удался." + data.closest('.t404__col').querySelector('.t404__titel').innerText());
				console.error("Проверь корректность возвращаемых данных из параметра 'Подзаголовок' в настройках страницы на которую ссылается данная карточка:\n" + data.closest('.t404__col').querySelector('.t404__tag').innerText());
		  		console.error(err.name);
		  		console.error(err.message);
			}
		});
		return projects; 
}



/*СОЗДАЕМ СПИСОК С УНИКАЛЬНЫМИ ПАРМЕТРАМИ ФИЛЬТРАЦИИ (ПО ТИПУ ОБЪЕКТА)*/

function createFilterTypesList () {	
	// Формируем список уникальных параметров ("типов") по которым будет проходить фильтрация
	let typesList = new Set();
	projectsData.forEach((data) => { // добавляем список "типов проектов для фильтрации
		typesList.add(data.type);
	});  
	return typesList; // Возвращем список уникальных параметров
}



/*СОБИРАЕМ БЛОК "ФИЛЬТР ПО ТИПУ ОБЪЕКТА"*/

function createFilterStructure (typesList){
		const filterBaseStructure = "<div class='FilterByType'><label class='FilterByType-Label'>Вид проекта</label><ul class='FilterByType-ChipsBlock'><li class='FilterByType-ChoiceChip FilterByType-ChoiceChip_active'><a href='javascript:void(0);' data-filter-option='Все'>Все</a></li></ul></div>";
		let parser = new DOMParser();
		let filterControl = parser.parseFromString(filterBaseStructure, "text/html").querySelector('.FilterByType'); // трансформируем строку с нужным HTML в DOM элементы

		for (let type of typesList) {
      // Добавляем в контрол filterControl "параметры фильтрации по типу объекта"
		  let listOption = "<li class='FilterByType-ChoiceChip'><a href='javascript:void(0);' data-filter-option='"+type+"'>"+type+"</a></li>"; // Структура контрола
		  let listElement = parser.parseFromString(listOption, "text/html").querySelector('.FilterByType-ChoiceChip'); // Трансформируем структуру контрла в DOM элемент
		  
		  // !!! можно добавить обработчик события в свойстве  DOM элемента 
		  listElement.onClick = function (){}

		  filterControl.querySelector('.FilterByType-ChipsBlock').appendChild(listElement); // Добавляем элемент в список фильтрующих параметров
		}


		return filterControl; // Возварщаем блок готовый к инсталяции в нужное место
}



/*СОБИРАЕМ БЛОК "ФИЛЬТР ПО ТИПУ ОБЪЕКТА"*/

function setEventsLIstenersToFilterByTypeControls(argument) {
	// body...
}


/*ДОБАВЛЕНИЕ ИНФОРМАЦИИ В КАЖДОЙ КАРТОЧКИ ПРОЕКТА*/

function setProjectData (data){
 // Заменяем информацию передаваемую в подзаголовок на "год" реализации этого проекта
  data.forEach((project) => {
    project.projectElm.querySelector('.t404__tag').innerText = project.year;
    project.projectElm.setAttribute('data-filter-by-type', project.type);
  });	
}


/*МАНИПУЛЯЦИИ С БЛОКОМ ФИЛЬТРА*/
 
//const filterBlock = document.querySelector(".FilterByType"); // ссылка на блок с контролами фильтра (ссылку на блок оставим напрозапас)
const filterBlock = document.querySelector(".uc-projects-filter"); // ссылка на блок с контролами фильтра (ссылку на блок оставим напрозапас)

let projectsData = parseProjectsBlock(".uc-projects-block"); // Получаем JSON с информацией о проектах
let filterElements = createFilterStructure (createFilterTypesList ()); // 1.) Создаем список уникальных параметров фильтрации 2.) Создаем контрол, который далее вставим в нужный узел

filterBlock.querySelector(".FiltersContainer").appendChild(filterElements); // Добавляем варианты филльтрации в фильтра по (виду проекта)



/*МАНИПУЛЯЦИИ С БЛОКОМ ПРОЕКТЫ*/

setProjectData(projectsData); // Убираем передваемою в подзаголовок информацию, вставляя туда дату проекта




/*ОТЛАДКА*/
console.log(projectsData);
});